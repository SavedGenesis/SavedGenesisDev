name: Deploy

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ghcr.io/savedgenesis/savedgenesisdev:latest

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -x  # Enable debug output
            echo "=== Starting deployment ==="
            echo "Current user: $(whoami)"
            echo "Current directory: $(pwd)"
            
            # Create directory (if it doesn't exist, it should already be created with proper permissions)
            mkdir -p /srv/savedgenesis
            cd /srv/savedgenesis
            echo "Working directory: $(pwd)"
            
            # Check Docker access
            echo "=== Checking Docker ==="
            docker --version || echo "Docker not found or not accessible"
            docker ps || echo "Cannot run docker ps"
            
            # Check Docker Compose
            echo "=== Checking Docker Compose ==="
            docker compose version || docker-compose version || echo "Docker Compose not found"
            
            # Log in to GHCR (public images might not need this, but try anyway)
            echo "=== Logging in to GHCR ==="
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin || echo "GHCR login failed (might be OK for public images)"
            
            # Create docker-compose.yml
            echo "=== Creating docker-compose.yml ==="
            cat > docker-compose.yml <<'EOF'
            version: "3.9"
            services:
              web:
                image: ghcr.io/savedgenesis/savedgenesisdev:latest
                restart: unless-stopped
                expose:
                  - "3000"
              caddy:
                image: caddy:2.8-alpine
                restart: unless-stopped
                ports:
                  - "9000:80"
                  - "9443:443"
                volumes:
                  - caddy_data:/data
                  - caddy_config:/config
                  - ./Caddyfile:/etc/caddy/Caddyfile:ro
                depends_on:
                  - web
            volumes:
              caddy_data:
              caddy_config:
            EOF
            echo "docker-compose.yml created"
            ls -la docker-compose.yml
            
            # Create Caddyfile
            echo "=== Creating Caddyfile ==="
            cat > Caddyfile <<'EOF'
            savedgenesis.com:9443, www.savedgenesis.com:9443 {
              encode zstd gzip
              header {
                Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
                X-Content-Type-Options nosniff
                X-Frame-Options DENY
                Referrer-Policy no-referrer-when-downgrade
              }
              reverse_proxy web:3000
            }
            savedgenesis.com:9000, www.savedgenesis.com:9000 {
              encode zstd gzip
              header {
                Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
                X-Content-Type-Options nosniff
                X-Frame-Options DENY
                Referrer-Policy no-referrer-when-downgrade
              }
              reverse_proxy web:3000
            }
            EOF
            echo "Caddyfile created"
            ls -la Caddyfile
            
            # Verify files exist
            echo "=== Verifying files ==="
            ls -la /srv/savedgenesis/
            
            # Determine docker compose command
            echo "=== Determining docker compose command ==="
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
            elif command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE="docker-compose"
            elif sudo docker compose version &> /dev/null; then
              DOCKER_COMPOSE="sudo docker compose"
            elif sudo docker-compose version &> /dev/null; then
              DOCKER_COMPOSE="sudo docker-compose"
            else
              echo "ERROR: Docker Compose not found!"
              exit 1
            fi
            echo "Using: $DOCKER_COMPOSE"
            
            # Pull images
            echo "=== Pulling images ==="
            $DOCKER_COMPOSE pull || {
              echo "ERROR: Failed to pull images"
              exit 1
            }
            
            # Check what's using ports (without sudo - using docker commands)
            echo "=== Checking port usage ==="
            docker ps --format "table {{.Names}}\t{{.Ports}}" | grep -E ':(80|443|9000|9443|8080|8443)' || echo "No Docker containers using these ports"
            
            # Stop existing containers if any
            echo "=== Stopping existing containers ==="
            $DOCKER_COMPOSE down || echo "No existing containers to stop"
            
            # Start containers
            echo "=== Starting containers ==="
            $DOCKER_COMPOSE up -d || {
              echo "ERROR: Failed to start containers"
              echo "Checking Docker containers:"
              docker ps -a || true
              echo "Checking container logs:"
              $DOCKER_COMPOSE logs || true
              exit 1
            }
            
            # Verify containers are running
            echo "=== Verifying containers ==="
            $DOCKER_COMPOSE ps
            
            echo "=== Deployment complete ==="


